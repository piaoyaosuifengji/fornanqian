#include<reg51.h>                  
#include<absacc.h>                
#include <intrins.h>           
/********自定义变量********/
#define uint unsigned int      //自定义变量
#define uchar unsigned char    
char gw,sw,bw,qw;
uchar j;  //定时次数，每次20ms
uchar f=5; //计数的次数
sbit  P10=P1^0;    //PWM输出波形1
sbit  P11=P1^1;    //PWM输出波形2
sbit  P12=P1^2;	   //正反转
sbit  P13=P1^3;	   //加速
sbit  P14=P1^4;	  //减速
sbit  P15=P1^5;	  //停止
sbit  P16=P1^6;   //启动
uchar k;
uchar t;   //脉冲加减
uchar code smg[]={0xC0,0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90,0xbf,0xff};//程序存储区定义字型码表
uchar data led[4]={0x08,0x04,0x02,0x01};      //位码
uint x;	     //数码管显示的数值

/*****************延时函数*************************/
void delays()
{
	uchar x,y;
	for(x=5;x>0;x--)
	for(y=124;y>0;y--);
}
/***************数码管显示****************/
void display()
{
	uchar i; 																		   
	gw=x%10;          //求速度个位值，送到个位显示缓冲区
	sw=(x/10)%10;     //求速度十位值，送到十位显示缓冲区
	bw=(x/100)%10;   //求速度百位值，送到百位显示缓冲区
	qw=x/1000;        //求速度千位值，送到千位显示缓冲区
	for(i=0;i<4;)
	{
		P2=led[i];
		if(i==0)                  //显示个位
		{
			P0=smg[gw];
		delays();
		}
			else if(i==1)     //显示十位
			{
			P0=smg[sw];
		delays();
			}
				else if(i==2)  //显示百位
				{
				P0=smg[bw];
				delays();
				}
			   else if(i==3)	   //显示千位
			  {
				if(k==0)			//正转时显示" "
				{
				 P0=0xff;
				 delays();
				}
				else
				{
				 P0=0xbf;		 //反转时显示"-"	
				 }
				 }				 
		i++;
	}
}

/****************按键扫描**************/
void key()
{
if(P12==0)	        //如果按下，
	{
	 while(!P12)    //去抖动
	 display(); 
	 k=~k;
	}	  
	if(P16==0)     //启动
	{
	while(P16==0);
	IE=0x8a;
	} 	  
if(P13==0)         //加速
	{
	while (P13==0);
	t++;
	}
		if(t>=5)
		t=5;
			if(P14==0)  //减速
			{
			while(P14==0);
			t--;
			}
			if(t<1)
			t=1;
if(P15==0)             //停止
	{
	while(P15==0);

	EA=0;
	P10=0;
	P11=0;
	} 	
}
/***************主函数********************/
void main ()
{ 	
	TMOD=0x51;   	//T0方式1  定时计数	T1方式1计数
	TH0=0xb1;	   //装入初值	  20MS
	TL0=0xe0;
	TH1=0x00;    //   计数567
	TL1=0x00;
	TR0=1;       //启动  t0
	TR1=1;       //启动t1
	gw=sw=bw=qw=0; //数码管初始化
	P0=0xc0;
	P2=1;
	while(1)        //无限循环
	 {
		display(); //数码管显示	
	 	key();
	   
	 }
}	
/*********t0定时*中断函数*************/
void t0() interrupt 1 using 2
{
	TH0=0xb1;  //重装t0
	TL0=0xe0;
	f--;
	if(k==0)
	{
	  if(f<t)
	  P10=1;
	  else  
	  P10=0;	
	  P11=0;
	 }
	else  
	{
		if(f<t)
		P11=1;
		else 
		P11=0;
		P10=0;
	}
	if(f==0)
		{
		f=5;
		}  
	 j++;
	 if(j==50)
 	{
	j=0;
	x=TH1*256+TL1;	 //t1方式1计数，读入计数值
	TH1=0x00;
	TL1=0x00;
 	x++;
	display();
	}
}
